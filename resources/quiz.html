<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cheeky Commodore Gamer - Retro Quiz</title>
    <meta name="description" content="Test your knowledge of 8-bit and 16-bit history with the interactive Retro Quiz.">
    
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link href="https://db.onlinewebfonts.com/c/05eb10077a913e99089a693039e6273e?family=Amiga+Topaz" rel="stylesheet"> 
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="../css/style.css">

    <style>
        /* === RESTORED ORIGINAL PAGE STYLES (Scoped for Quiz) === */
        :root {
            --c64-blue: #352879; --c64-light-blue: #6c5eb5; --c64-text: #b8c76f; --c64-red: #880000;
            --amiga-blue: #0055AA; --amiga-white: #FFFFFF; --amiga-orange: #FF8800; --amiga-black: #000000;
            --amiga-green: #00AA00; --amiga-red: #FF0000; --shadow: rgba(0,0,0,0.5);
        }

        body {
            font-family: 'VT323', monospace; margin: 0; padding: 0; 
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
            text-transform: uppercase; overflow-x: hidden; transition: filter 0.3s ease; 
        }

        /* --- STARFIELD & CRT --- */
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.3; pointer-events: none; }
        .crt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 9999; }

        /* --- MODES --- */
        body.c64-mode { background-color: var(--c64-blue); color: var(--c64-text); }
        body.amiga-mode { background: linear-gradient(180deg, #0055AA 0%, #003D7A 100%); color: var(--amiga-white); font-family: 'Amiga Topaz', monospace; }

        /* --- QUIZ WINDOW STYLES --- */
        .quiz-container {
            width: 95%; max-width: 800px; margin-top: 20px; margin-bottom: 60px;
            position: relative; z-index: 1;
        }

        .amiga-window {
            width: 100%;
            background: var(--amiga-white);
            border: 3px solid var(--amiga-white);
            box-shadow: 8px 8px 0px rgba(0,0,0,0.5), 0 0 20px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            z-index: 10;
            color: var(--amiga-black);
        }
        
        body.c64-mode .amiga-window {
            border: 4px solid var(--c64-light-blue);
            background-color: rgba(53, 40, 121, 0.95);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            color: var(--c64-text);
        }

        /* Title Bar */
        .window-title-bar {
            background: linear-gradient(180deg, #0066CC 0%, #0044AA 100%);
            color: var(--amiga-white); height: 32px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 8px; font-weight: bold;
            border: 3px solid var(--amiga-white); border-bottom: none;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
        }
        body.c64-mode .window-title-bar {
            background: var(--c64-light-blue);
            color: var(--c64-blue);
            border: none;
        }

        .title-left { display: flex; align-items: center; gap: 10px; }
        .close-gadget {
            width: 22px; height: 18px;
            background: linear-gradient(180deg, #FF4444 0%, #CC0000 100%);
            border: 2px outset #FFFFFF; cursor: pointer;
        }
        body.c64-mode .close-gadget { background: var(--c64-red); border: 1px solid #fff; }
        .depth-gadget {
            width: 22px; height: 18px;
            background: linear-gradient(180deg, #FFFFFF 0%, #CCCCCC 100%);
            border: 2px outset #FFFFFF;
        }
        body.c64-mode .depth-gadget { display: none; }

        /* Window Content */
        .window-content {
            padding: 20px;
            border: 3px solid var(--amiga-blue); border-top: none;
            background: var(--amiga-white);
            min-height: 400px;
        }
        body.c64-mode .window-content {
            background-color: var(--c64-blue);
            color: var(--c64-text);
            border: none;
        }

        /* Buttons */
        .quiz-btn {
            background: linear-gradient(180deg, #EEEEEE 0%, #CCCCCC 100%);
            color: #000;
            border: 2px outset #FFFFFF;
            padding: 12px 20px; font-family: inherit; font-size: 1.1rem;
            cursor: pointer; width: 100%; margin-bottom: 10px;
            text-transform: uppercase; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: all 0.1s;
        }
        body.c64-mode .quiz-btn {
            background: var(--c64-light-blue);
            color: #fff;
            border: 2px solid #fff;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }
        .quiz-btn:hover { transform: translateY(-2px); }
        body.amiga-mode .quiz-btn:hover { background: linear-gradient(180deg, #FFFFFF 0%, #DDDDDD 100%); }
        body.c64-mode .quiz-btn:hover { background: #fff; color: var(--c64-blue); }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .btn-grid { grid-template-columns: 1fr; } }

        /* Quiz Elements */
        .score-ticker {
            display: flex; justify-content: space-between;
            background: linear-gradient(180deg, var(--amiga-blue) 0%, #003D7A 100%);
            color: #fff; padding: 10px 15px; margin-bottom: 20px;
            border: 3px solid var(--amiga-black); font-weight: bold;
        }
        body.c64-mode .score-ticker {
            background: var(--c64-blue);
            border: 2px solid var(--c64-text);
            color: var(--c64-text);
        }

        .progress-bar { width: 100%; height: 20px; background: #ccc; border: 2px solid #000; margin: 10px 0; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--amiga-blue) 0%, var(--amiga-orange) 100%); transition: width 0.5s ease; }
        body.c64-mode .progress-fill { background: var(--c64-light-blue); }

        .question-image {
            max-width: 100%; max-height: 300px; display: block; margin: 0 auto 15px auto;
            border: 4px solid var(--amiga-black); box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
            animation: imageReveal 0.5s ease-out;
        }
        body.c64-mode .question-image { border-color: var(--c64-light-blue); }
        @keyframes imageReveal { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .feedback { text-align: center; font-size: 1.6rem; margin: 20px 0; min-height: 40px; font-weight: bold; }
        .correct { color: var(--amiga-green); } body.c64-mode .correct { color: #55cc55; }
        .wrong { color: var(--amiga-red); } body.c64-mode .wrong { color: var(--c64-red); }

        input[type="text"] {
            width: 100%; padding: 12px; border: 3px inset #999; font-family: inherit; 
            font-size: 1.2rem; margin-bottom: 15px; text-transform: uppercase;
        }
        body.c64-mode input[type="text"] {
            background: var(--c64-blue); color: var(--c64-text); border: 2px solid var(--c64-light-blue);
        }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 1rem; }
        th { background: var(--amiga-blue); color: #fff; padding: 10px; border: 1px solid #000; }
        td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        body.c64-mode th { background: var(--c64-light-blue); color: var(--c64-blue); border-color: var(--c64-text); }
        body.c64-mode td { border-color: var(--c64-light-blue); }

        .hidden { display: none !important; }
        
        /* Loader */
        .disk-loader {
            width: 60px; height: 60px; border: 5px solid var(--amiga-blue);
            border-top-color: var(--amiga-orange); border-radius: 50%;
            margin: 30px auto; animation: diskSpin 1s infinite linear;
        }
        body.c64-mode .disk-loader { border-color: var(--c64-blue); border-top-color: var(--c64-light-blue); }
        @keyframes diskSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="c64-mode"> 
    
    <canvas id="starfield"></canvas>
    <div class="crt-overlay"></div>

    <div id="global-header-container"></div>

    <div class="quiz-container" id="top">
        
        <div class="amiga-window">
            <div class="window-title-bar">
                <div class="title-left">
                    <div class="close-gadget play-sound" onclick="window.location.href='/index.html'" title="Exit to Home"></div>
                    <span>üéÆ CHEEKY COMMODORE GAMER - QUIZ MASTER</span>
                </div>
                <div class="depth-gadget"></div>
            </div>
            
            <div class="window-content">

                <div id="screen-loading" class="hidden">
                    <div class="disk-loader"></div>
                    <p style="text-align: center; font-size: 1.2rem;">READING DISK DRIVE...</p>
                    <p style="text-align: center; opacity: 0.7;">Please wait...</p>
                </div>

                <div id="screen-home">
                    <h1 style="text-align:center; margin-bottom:20px;">RETRO QUIZ SYSTEM</h1>
                    <div style="text-align:center; margin-bottom:20px; background:rgba(0,0,0,0.1); padding:10px;">
                        <span id="global-stats">üë• LOADING STATS...</span>
                    </div>
                    <p style="font-size: 1.2rem; margin: 20px 0;">SELECT YOUR CHALLENGE:</p>
                    <div id="quiz-list" class="btn-grid"></div>
                    
                    <div style="margin-top: 20px;">
                        <button class="quiz-btn play-sound" onclick="app.showLeaderboard(null)">
                            <i class="fa-solid fa-trophy"></i> VIEW HALL OF FAME
                        </button>
                    </div>
                </div>

                <div id="screen-quiz" class="hidden">
                    <div class="score-ticker">
                        <span><i class="fa-solid fa-clock"></i> <span id="timer-display">00:00</span></span>
                        <span><i class="fa-solid fa-star"></i> <span id="score-display">0/0</span></span>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    
                    <div id="media-container" style="text-align:center; margin-bottom:15px;"></div>
                    <h2 id="question-text" style="text-align:center; margin-bottom:20px;">Loading Question...</h2>
                    <div id="options-container" class="btn-grid"></div>
                    <div id="feedback-display" class="feedback"></div>
                </div>

                <div id="screen-result" class="hidden" style="text-align:center;">
                    <h1>üèÜ GAME OVER üèÜ</h1>
                    <h2>FINAL SCORE</h2>
                    <h3 id="final-score" style="font-size: 2.5rem; margin: 20px 0;">0 / 0</h3>
                    <div style="background: rgba(0,0,0,0.05); padding: 15px; border: 1px solid currentColor; margin: 20px 0;">
                        <p id="final-percent" style="font-size: 1.3rem; margin: 5px 0;">üìä ACCURACY: 0%</p>
                        <p id="final-time" style="font-size: 1.3rem; margin: 5px 0;">‚è±Ô∏è TIME: 0s</p>
                    </div>
                    
                    <div style="max-width: 400px; margin: 20px auto; border: 2px solid currentColor; padding: 20px;">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">üéØ ENTER YOUR NAME:</p>
                        <input type="text" id="player-name" placeholder="PLAYER 1" maxlength="10">
                        <button class="quiz-btn play-sound" onclick="app.submitScore()">
                            <i class="fa-solid fa-floppy-disk"></i> SAVE TO DISK
                        </button>
                    </div>
                    
                    <div class="btn-grid">
                        <button class="quiz-btn play-sound" onclick="app.init()">
                            <i class="fa-solid fa-rotate-left"></i> PLAY AGAIN
                        </button>
                        <button class="quiz-btn play-sound" onclick="window.location.href='/index.html'">
                            <i class="fa-solid fa-house"></i> EXIT
                        </button>
                    </div>
                </div>

                <div id="screen-leaderboard" class="hidden">
                    <h1 style="text-align:center;">üèÜ HALL OF FAME üèÜ</h1>
                    <div class="btn-grid">
                        <button class="quiz-btn play-sound" onclick="app.fetchOverallLeaderboard()">
                            <i class="fa-solid fa-globe"></i> OVERALL TOTALS
                        </button>
                        <button class="quiz-btn play-sound" onclick="app.init()">
                            <i class="fa-solid fa-arrow-left"></i> BACK
                        </button>
                    </div>
                    <div id="lb-content" style="margin-top:20px;"></div>
                </div>

            </div>
        </div>
    </div>

    <script src="../js/global.js"></script>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwhkSGA6HcSvCljqBA91JmQVsVVUPU5LCEO1HlifB_Cjwc0DTFCK3m6hG5ZFDSgVHw9/exec';

        // --- STARFIELD RESTORED ---
        const cvs = document.getElementById('starfield');
        const cx = cvs.getContext('2d');
        let stars = [];
        function initStars() {
            cvs.width = window.innerWidth; cvs.height = window.innerHeight;
            stars = Array(100).fill().map(() => ({
                x: Math.random() * cvs.width, y: Math.random() * cvs.height,
                size: Math.random() * 2, speed: Math.random() * 3 + 0.5
            }));
        }
        function drawStars() {
            cx.clearRect(0,0,cvs.width,cvs.height); cx.fillStyle = "#fff";
            stars.forEach(s => {
                cx.fillRect(s.x, s.y, s.size, s.size);
                s.y += s.speed;
                if(s.y > cvs.height) s.y = 0;
            });
            requestAnimationFrame(drawStars);
        }
        window.addEventListener('resize', initStars); initStars(); drawStars();

        // === QUIZ LOGIC ===
        const app = {
            state: {
                currentSetId: null, currentSetName: null, questions: [],
                currentQuestionIndex: 0, score: 0, startTime: 0, endTime: 0, timerInterval: null
            },

            init: async function() {
                this.showScreen('screen-loading');
                try {
                    const [setsResponse, countersResponse] = await Promise.all([
                        fetch(`${API_URL}?getQuizSets=true`),
                        fetch(`${API_URL}?getCounters=true`)
                    ]);

                    const setsData = await setsResponse.json();
                    const countersData = await countersResponse.json();

                    document.getElementById('global-stats').innerText = 
                        `üë• VISITORS: ${countersData.visitors || 0} | üéØ GAMES: ${countersData.games || 0}`;

                    const list = document.getElementById('quiz-list');
                    list.innerHTML = '';
                    
                    if(setsData.sets && setsData.sets.length > 0) {
                        setsData.sets.forEach(s => {
                            const btn = document.createElement('button');
                            btn.className = "quiz-btn play-sound";
                            let icon = '<i class="fa-solid fa-gamepad"></i>';
                            if (s.name.toUpperCase().includes('MUSIC')) icon = '<i class="fa-solid fa-music"></i>';
                            if (s.name.toUpperCase().includes('IMAGE')) icon = '<i class="fa-solid fa-image"></i>';
                            
                            btn.innerHTML = `${icon} <span>${s.name}</span>`;
                            btn.onclick = () => this.loadQuiz(s.id, s.name);
                            list.appendChild(btn);
                        });
                    } else {
                        list.innerHTML = '<p>NO QUIZZES FOUND.</p>';
                    }
                    this.showScreen('screen-home');
                } catch (e) {
                    console.error('Init error:', e);
                    alert("Failed to load quiz data. Please refresh.");
                }
            },

            loadQuiz: async function(setId, setName) {
                this.showScreen('screen-loading');
                try {
                    const response = await fetch(`${API_URL}?set=${setId}`);
                    const data = await response.json();
                    
                    fetch(`${API_URL}?action=trackGameStart`, { method: 'POST' }).catch(() => {});

                    this.state.currentSetId = setId;
                    this.state.questions = data.questions;
                    this.state.currentQuestionIndex = 0;
                    this.state.score = 0;
                    this.state.startTime = new Date();
                    
                    this.startTimer();
                    this.renderQuestion();
                    this.showScreen('screen-quiz');
                } catch (e) {
                    alert('Error loading quiz: ' + e.message);
                    this.init();
                }
            },

            renderQuestion: function() {
                const q = this.state.questions[this.state.currentQuestionIndex];
                const total = this.state.questions.length;
                
                document.getElementById('feedback-display').innerText = '';
                document.getElementById('options-container').innerHTML = '';
                document.getElementById('media-container').innerHTML = '';
                document.getElementById('score-display').innerText = `${this.state.score}/${total}`;
                document.getElementById('question-text').innerText = q.question;
                
                // Progress Bar
                document.getElementById('progress-fill').style.width = ((this.state.currentQuestionIndex + 1) / total * 100) + '%';

                // Media Handling
                if (q.imageUrl && q.imageUrl.startsWith('http')) {
                    const img = document.createElement('img');
                    img.src = q.imageUrl; img.className = 'question-image';
                    document.getElementById('media-container').appendChild(img);
                }
                if (q.audioUrl && q.audioUrl.startsWith('http')) {
                    const audio = document.createElement('audio');
                    audio.src = q.audioUrl; audio.controls = true; audio.autoplay = true;
                    document.getElementById('media-container').appendChild(audio);
                }

                q.options.forEach((opt, index) => {
                    const btn = document.createElement('button');
                    btn.className = "quiz-btn play-sound";
                    btn.innerText = opt;
                    btn.onclick = () => this.handleAnswer(index + 1, q.answer);
                    document.getElementById('options-container').appendChild(btn);
                });
            },

            handleAnswer: function(selected, correct) {
                const btns = document.querySelectorAll('#options-container button');
                btns.forEach(b => b.disabled = true);

                const feedback = document.getElementById('feedback-display');
                if (selected === correct) {
                    this.state.score++;
                    feedback.innerHTML = "‚úÖ CORRECT!";
                    feedback.className = "feedback correct";
                } else {
                    feedback.innerHTML = "‚ùå WRONG!";
                    feedback.className = "feedback wrong";
                }

                setTimeout(() => {
                    this.state.currentQuestionIndex++;
                    if (this.state.currentQuestionIndex < this.state.questions.length) {
                        this.renderQuestion();
                    } else {
                        this.endGame();
                    }
                }, 1500);
            },

            startTimer: function() {
                if(this.state.timerInterval) clearInterval(this.state.timerInterval);
                const start = new Date();
                this.state.timerInterval = setInterval(() => {
                    const now = new Date();
                    const diff = Math.floor((now - start) / 1000);
                    const mins = Math.floor(diff / 60).toString().padStart(2, '0');
                    const secs = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('timer-display').innerText = `${mins}:${secs}`;
                }, 1000);
            },

            endGame: function() {
                clearInterval(this.state.timerInterval);
                this.state.endTime = new Date();
                const duration = Math.round((this.state.endTime - this.state.startTime) / 1000);
                const total = this.state.questions.length;
                const percent = Math.round((this.state.score / total) * 100);

                document.getElementById('final-score').innerText = `${this.state.score} / ${total}`;
                document.getElementById('final-percent').innerText = `üìä ACCURACY: ${percent}%`;
                document.getElementById('final-time').innerText = `‚è±Ô∏è TIME: ${duration}s`;
                
                this.showScreen('screen-result');
            },

            submitScore: async function() {
                const name = document.getElementById('player-name').value.trim();
                if (!name) { alert("Please enter your name!"); return; }

                const saveBtn = document.querySelector('#screen-result button');
                saveBtn.innerText = "SAVING..."; saveBtn.disabled = true;

                const payload = {
                    action: 'saveScore',
                    set: this.state.currentSetId,
                    name: name,
                    score: this.state.score,
                    total: this.state.questions.length,
                    duration: Math.round((this.state.endTime - this.state.startTime) / 1000),
                    percent: Math.round((this.state.score / this.state.questions.length) * 100)
                };

                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                    this.showLeaderboard(this.state.currentSetId);
                } catch (e) {
                    alert("Error saving score: " + e.message);
                    saveBtn.innerText = "SAVE TO DISK"; saveBtn.disabled = false;
                }
            },

            showLeaderboard: async function(setId) {
                this.showScreen('screen-loading');
                try {
                    const response = await fetch(`${API_URL}?getLeaderboard=${setId || 'true'}`);
                    const data = await response.json();
                    this.renderTable(data.entries, ['#', 'NAME', 'SCORE']);
                    this.showScreen('screen-leaderboard');
                } catch (e) {
                    alert("Error loading leaderboard");
                    this.init();
                }
            },

            fetchOverallLeaderboard: async function() {
                this.showScreen('screen-loading');
                try {
                    const response = await fetch(`${API_URL}?getOverallTotals=true`);
                    const data = await response.json();
                    const players = data.players.map(p => ({ name: p.name, score: p.totalScore }));
                    this.renderTable(players, ['#', 'NAME', 'TOTAL PTS']);
                    this.showScreen('screen-leaderboard');
                } catch (e) {
                    alert("Error loading overall stats");
                    this.init();
                }
            },

            renderTable: function(data, headers) {
                const container = document.getElementById('lb-content');
                if (!data || data.length === 0) {
                    container.innerHTML = "<p>NO SCORES YET.</p>";
                    return;
                }
                let html = `<table><thead><tr>`;
                headers.forEach(h => html += `<th>${h}</th>`);
                html += `</tr></thead><tbody>`;
                data.forEach((row, i) => {
                    let medal = i === 0 ? 'ü•á ' : i === 1 ? 'ü•à ' : i === 2 ? 'ü•â ' : '';
                    html += `<tr><td>${medal}${i+1}</td><td>${row.name}</td><td>${row.score}</td></tr>`;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            showScreen: function(id) {
                document.querySelectorAll('.window-content > div').forEach(d => d.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            }
        };

        // Start App
        window.onload = () => app.init();
    </script>
</body>
</html>
